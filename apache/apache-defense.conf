# Apache 능동방어 시스템 설정
# mod_security, mod_evasive, mod_qos를 활용한 능동방어

<IfModule mod_security.c>
    # ModSecurity 기본 설정
    SecRuleEngine On
    SecRequestBodyAccess On
    SecResponseBodyAccess On
    
    # 위협 방지 규칙
    # SQL Injection 방어
    SecRule ARGS "@detectSQLi" \
        "id:1000,deny,status:403,msg:'SQL Injection Attempt',logdata:'%{MATCHED_VAR}'"
    
    # XSS 방어
    SecRule ARGS "@detectXSS" \
        "id:1001,deny,status:403,msg:'XSS Attempt'"
    
    # 명령어 주입 방어
    SecRule ARGS|ARGS_NAMES|REQUEST_HEADERS "@detectCmdInjection" \
        "id:1002,deny,status:403,msg:'Command Injection Attempt'"
    
    # 느린 HTTP DoS 방어
    SecRequestBodyLimitAction Reject
    SecRequestBodyNoFilesLimit 1048576
    SecRequestBodyLimit 1048576
    
    # Rate Limiting
    SecAction "id:1003,phase:1,nolog,pass,initcol:ip=%{REMOTE_ADDR},initcol:user=%{REMOTE_ADDR},deprecatevar:ip.suspicious_counter"
    SecRule IP:COUNTER "@gt 100" \
        "id:1004,phase:1,deny,status:403,msg:'Rate limit exceeded'"
    
    # 악성 IP 차단
    SecRule REMOTE_ADDR "@ipMatch 1.2.3.4,5.6.7.8" \
        "id:1005,deny,status:403,msg:'Blocked IP'"
    
    # GeoIP 기반 차단 (선택사항)
    # SecRule GEO:COUNTRY_CODE "@geoLookup" \
    #     "id:1006,phase:1,deny,status:403,msg:'Country not allowed'"
    
    # Bot 차단
    SecRule REQUEST_HEADERS:User-Agent "@contains bot" \
        "id:1007,block,status:403,msg:'Bot detected'"
    
    SecRule REQUEST_HEADERS:User-Agent "@contains crawler" \
        "id:1008,block,status:403,msg:'Crawler detected'"
    
    SecRule REQUEST_HEADERS:User-Agent "@contains spider" \
        "id:1009,block,status:403,msg:'Spider detected'"
    
    # 가짜 User-Agent 차단
    SecRule REQUEST_HEADERS:User-Agent "^$" \
        "id:1010,deny,status:403,msg:'Missing User-Agent'"
    
    # 특정 경로 보호 (관리자 페이지)
    SecRule REQUEST_URI "@beginsWith /admin" \
        "id:1011,phase:1,block,status:403,msg:'Admin access denied'"
    
    # PHP 파일 스캔 방어
    SecRule REQUEST_URI "\.(php|asp|jsp)$" \
        "id:1012,deny,status:444,msg:'PHP scan attempt',chain"
    SecRule REQUEST_METHOD "^GET$"
    
    # 디렉토리 탐색 방어
    SecRule REQUEST_URI "@contains ../" \
        "id:1013,deny,status:403,msg:'Directory traversal attempt'"
    
    SecRule REQUEST_URI "@contains ..\\" \
        "id:1014,deny,status:403,msg:'Directory traversal attempt'"
    
    # HTTP 허니토큰 (의심스러운 요청에 가짜 응답)
    SecRule REMOTE_ADDR "@ipMatch 192.168.1.100" \
        "id:1015,pass,msg:'Honey token trap',phase:1"
    
    # 로그 설정
    SecAuditLog /var/log/apache2/modsecurity_audit.log
    SecAuditLogType Serial
    SecAuditLogStorageDir /var/log/apache2/audit/
    
    # 이상 징후 로깅
    SecRule REMOTE_ADDR "@ipMatch 192.168.1.100" \
        "id:1016,phase:1,pass,exec:/usr/local/bin/honey-trap-handler.sh"
</IfModule>

# mod_evasive 설정 (DDoS 방어)
<IfModule mod_evasive.c>
    DOSHashTableSize    2048
    DOSPageCount        10
    DOSPageInterval     1
    DOSSiteCount        100
    DOSSiteInterval     1
    DOSBlockingPeriod   600
    
    # IP 차단 목록
    DOSEmailNotify admin@yourdomain.com
    DOSSystemCommand "/usr/local/bin/dos-notify.sh %s"
</IfModule>

# mod_qos 설정 (Quality of Service)
<IfModule mod_qos.c>
    # 심각도 레벨에 따른 처리 우선순위
    QS_Phrases
    QS_SrvMaxConnClose 200
    
    # 요청 처리율 제한
    QS_LimitSLocationIP /api/.* 80 1 5 60
    QS_LimitSLocationIP /upload/.* 10 1 5 60
    
    # 서버 연결 제한
    QS_SrvMaxConn 1000
    QS_SrvMaxConnClose 200
    QS_SrvMaxConnClosePerSec 10
</IfModule>

# Apache 가상 호스트 설정 (능동방어 적용)
<VirtualHost *:80>
    ServerName your-domain.com
    
    # 기본 보안 헤더
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Content-Security-Policy "default-src 'self'"
    
    # 연결 제한
    MaxRequestWorkers 256
    ThreadsPerChild 25
    
    # 타임아웃 설정 (능동방어)
    Timeout 30
    KeepAlive On
    KeepAliveTimeout 5
    MaxKeepAliveRequests 100
    
    # 요청 크기 제한
    LimitRequestBody 10485760
    LimitRequestFields 100
    LimitRequestFieldSize 8190
    LimitRequestLine 8190
    
    # 음성 위치 설정
    DocumentRoot /var/www/html
    
    <Directory /var/www/html>
        Options -Indexes -ExecCGI
        AllowOverride None
        Require all granted
    </Directory>
    
    # 로그 설정
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
    
    # 능동방어 로그
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" \"%{X-Forwarded-For}i\" attack=\"%{TX.ANOMALY_SCORE}i\" block=\"%{TX.BLOCK}i\"" security
    CustomLog ${APACHE_LOG_DIR}/security.log security
    
    # 특정 IP 차단 (444 사용)
    <LocationMatch ".*">
        SetEnvIfExpr "%{REMOTE_ADDR} == '1.2.3.4'" block_ip
        Header always set Connection "close" env=block_ip
    </LocationMatch>
    
    # API 엔드포인트 Rate Limiting
    <Location "/api/">
        # 추가 제한 규칙
        QS_LimitReqAuth 10 1
    </Location>
    
    # 관리자 페이지 추가 보호
    <Location "/admin/">
        AuthType Basic
        AuthName "Admin Area"
        AuthUserFile /etc/apache2/.htpasswd
        Require valid-user
        
        # 추가 IP 화이트리스트
        Require ip 192.168.1.0/24
        Require ip 127.0.0.1
    </Location>
</VirtualHost>

# 능동방어를 위한 특별 설정
# 444 상태 코드로 연결 종료 (nginx와 동일한 전략)
<LocationMatch ".*">
    # 핸들러 스크립트를 통해 444 구현
    RewriteEngine On
    RewriteCond %{REMOTE_ADDR} ^1\.2\.3\.4$
    RewriteRule .* - [E=blocked:1]
    
    # 환경 변수 기반 차단
    <If "-z reqenv('blocked') == false">
        # Lua 스크립트로 444 처리 (mod_lua 필요)
        <IfModule mod_lua.c>
            <Location />
                LuaHookCheckRequest "return 444"
            </Location>
        </IfModule>
    </If>
</LocationMatch>

# Apache 성능 최적화 (능동방어와 함께)
<IfModule mod_mpm_event.c>
    StartServers 8
    MinSpareThreads 25
    MaxSpareThreads 75
    ThreadLimit 64
    ThreadsPerChild 25
    MaxRequestWorkers 400
    MaxConnectionsPerChild 10000
</IfModule>

<IfModule mod_mpm_prefork.c>
    StartServers 8
    MinSpareServers 5
    MaxSpareServers 20
    MaxRequestWorkers 256
    MaxConnectionsPerChild 10000
</IfModule>

# 압축 설정 (대역폭 절약)
<IfModule mod_deflate.c>
    DeflateCompressionLevel 6
    DeflateBufferSize 8096
    DeflateMemLevel 9
    DeflateWindowSize 15
    
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# 캐싱 설정
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
</IfModule>
